# .github/workflows/ssl_expiry.yml
name: ssl-expiry-watchdog

on:
  schedule:
    - cron: "17 2 * * *"   # Run nightly at 02:17
  workflow_dispatch:        # Manual trigger
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/ssl-expiry.yml'

jobs:
  check:
    # Only run on main branch or manual trigger
    if: github.ref == 'refs/heads/main' || github.event_name != 'push'
    runs-on: ubuntu-latest
    env:
      # Updated domain list to match the "Grand Central Station" architecture
      DOMAINS: |
        ki7mt.io
        adif-mcp.com
        www.adif-mcp.com
      THRESHOLD_DAYS: "15"
    steps:
      - name: Show inputs
        run: |
          echo "Monitoring certificates for:"
          echo "${DOMAINS}"
          echo "Alert threshold: ${THRESHOLD_DAYS} days"

      - name: Check certificate expiry
        id: check
        shell: bash
        run: |
          set -euo pipefail

          NOW_EPOCH=$(date +%s)
          FAIL=0
          printf "### ðŸ›°ï¸ SSL Expiry Report\n\n" >> "$GITHUB_STEP_SUMMARY"
          printf "| Domain | Not After (UTC) | Days Left |\n" >> "$GITHUB_STEP_SUMMARY"
          printf "|---|---:|---:|\n" >> "$GITHUB_STEP_SUMMARY"

          while IFS= read -r DOMAIN; do
            [[ -z "$DOMAIN" ]] && continue

            # Pull leaf cert and extract notAfter
            ENDDATE_RAW=$(echo | \
              openssl s_client -servername "$DOMAIN" -connect "$DOMAIN:443" 2>/dev/null | \
              openssl x509 -noout -enddate | cut -d= -f2 || true)

            if [[ -z "$ENDDATE_RAW" ]]; then
              echo "ERROR: Could not retrieve certificate for $DOMAIN"
              printf "| %s | %s | %s |\n" "$DOMAIN" "**ERROR**" "-" >> "$GITHUB_STEP_SUMMARY"
              FAIL=1
              continue
            fi

            # Convert to epoch
            END_EPOCH=$(date -u -d "$ENDDATE_RAW" +%s)
            SECS_LEFT=$(( END_EPOCH - NOW_EPOCH ))
            DAYS_LEFT=$(( SECS_LEFT / 86400 ))

            # Summary row
            printf "| %s | %s | %d |\n" "$DOMAIN" "$ENDDATE_RAW" "$DAYS_LEFT" >> "$GITHUB_STEP_SUMMARY"

            # Alert if under threshold
            if (( DAYS_LEFT < THRESHOLD_DAYS )); then
              echo "WARN: $DOMAIN has ${DAYS_LEFT} day(s) left (< ${THRESHOLD_DAYS})."
              FAIL=1
            fi
          done <<< "$DOMAINS"

          if (( FAIL > 0 )); then
            echo "::error title=SSL Expiry Alert::One or more domains are below ${THRESHOLD_DAYS} days."
            exit 1
          fi

          echo "All certificates are healthy."
